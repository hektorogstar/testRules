{
  "name": "pr2dwOthers",
  "rule": "sqls.dwhouse.execute \"TRUNCATE TABLE cimspr_idr_stg\"\nsqls.dwhouse.withBatch(1000, \"\"\"\nINSERT INTO cimspr_idr_stg (\n  identity_id,\n  id_type_id,\n  id_source_id,\n  id,\n  id_lastupddttm,\n  id_type_name,\n  id_source_name\n) VALUES ( ?,?,?,?,?,?,?)\n\"\"\") { ps ->\t\n\tsqls.cimspr.eachRow(\"\"\"\n\tSELECT \n\tx.identity_id AS identity_id, \n\tx.id_type_id AS id_type_id, \n\tx.id_source_id AS id_source_id,\n\tCASE WHEN MIN(x.id) <> MAX(x.id) THEN CONCAT('(MULTIPLE: Has ',COUNT(DISTINCT x.id),' of them)') ELSE MIN(x.id) END AS id,\n\tMIN(lastupddttm) AS id_lastupddttm,\n\tMIN(id_type_name) AS id_type_name,\n\tMIN(id_source_name) AS id_source_name\n\tFROM (\n\t\tSELECT DISTINCT\n\t\ti.identity_id\n\t\t, i.identifier_type_id as id_type_id\n\t\t, i.source_id as id_source_id\n\t\t, SUBSTR(i.identifier,1,255) as id\n\t\t, i.merge_date as lastupddttm\n\t\t, SUBSTR(itype.identifier_name,1,100) as id_type_name\n\t\t, SUBSTR(isrc.name,1,128) as id_source_name\n\t\tFROM idr_identifiers i\n\t\tJOIN ctd_identifier_types itype on itype.identifier_type_id = i.identifier_type_id\n\t\tJOIN ctd_sources isrc on isrc.source_id = i.source_id\n\t\tWHERE i.identity_id > 3\n\t\tAND i.status = 'Active'\n\t\tAND i.identifier_type_id NOT IN ( 1, 2, 4, 10, 11 )\n\t) x\n\tGROUP BY x.identity_id, x.id_type_id, x.id_source_id\n\t\"\"\") { r ->\n\t\tps.addBatch(r.identity_id as Integer,r.id_type_id as Integer,r.id_source_id as Integer,r.id,r.id_lastupddttm,r.id_type_name as String,r.id_source_name as String)\n\t}\t\n}\nsqls.dwhouse.execute \"\"\"INSERT INTO cimspr_idr (\n  identity_id,\n  id_type_id,\n  id_source_id,\n  id,\n  id_lastupddttm,\n  id_type_name,\n  id_source_name,\n  effective_status\n)\nSELECT DISTINCT identity_id, id_type_id, id_source_id, id, id_lastupddttm, id_type_name, id_source_name, 'A'\nFROM cimspr_idr_stg\nWHERE id_type_id NOT IN ( 1, 2, 4, 10, 11)\nMINUS \nSELECT DISTINCT identity_id, id_type_id, id_source_id, id, id_lastupddttm, id_type_name, id_source_name, 'A'\nFROM cimspr_idr_v  \nWHERE id_type_id NOT IN ( 1, 2, 4, 10, 11)\"\"\"\nsqls.dwhouse.execute \"\"\"INSERT INTO cimspr_idr (\n  identity_id,\n  id_type_id,\n  id_source_id,\n  id,\n  id_lastupddttm,\n  id_type_name,\n  id_source_name,\n  effective_status\n)\nSELECT DISTINCT cimspr_idr_v.identity_id, cimspr_idr_v.id_type_id, cimspr_idr_v.id_source_id, cimspr_idr_v.id, cimspr_idr_v.id_lastupddttm, cimspr_idr_v.id_type_name, cimspr_idr_v.id_source_name, 'I'\nFROM cimspr_idr_v  \nLEFT OUTER JOIN cimspr_idr_stg ON cimspr_idr_stg.identity_id = cimspr_idr_v.IDENTITY_ID and cimspr_idr_stg.id_type_id = cimspr_idr_v.ID_TYPE_ID and cimspr_idr_stg.id_source_id = cimspr_idr_v.ID_SOURCE_ID\nWHERE cimspr_idr_stg.identity_id IS NULL\nAND 0 < (SELECT COUNT(*) FROM cimspr_idr_stg WHERE id_type_id NOT IN ( 1, 2, 4, 10, 11 ))  \nAND cimspr_idr_v.ID_TYPE_ID NOT IN ( 1, 2, 4, 10, 11 )\"\"\"",
  "class": "edu.usf.RuleChains.Groovy"
}